<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workout History</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
      background: #f5f5f5;
    }
    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    .back-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .back-btn:hover {
      background: #5a6268;
    }
    .filter-section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .filter-section label {
      margin-right: 10px;
      font-weight: bold;
    }
    .filter-section input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-right: 10px;
    }
    .filter-section button {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 20px;
      cursor: pointer;
      border-radius: 5px;
    }
    .filter-section button:hover {
      background: #0056b3;
    }
    .log-card {
      background: white;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-left: 4px solid #007bff;
    }
    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .log-header-left {
      flex: 1;
    }
    .exercise-name {
      font-size: 20px;
      font-weight: bold;
      color: #007bff;
      margin-bottom: 5px;
    }
    .log-date {
      color: #666;
      font-size: 14px;
    }
    .log-body {
      display: flex;
      justify-content: space-between;
      gap: 20px;
    }
    .sets-column {
      flex: 1;
    }
    .set-row {
      padding: 8px 0;
      color: #333;
      font-size: 15px;
    }
    
    /* GIF Column */
    .gif-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .gif-thumbnail {
      width: 120px;
      height: 213px; /* 9:16 aspect ratio */
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      border: 2px solid #007bff;
      object-fit: cover;
    }
    .gif-thumbnail:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    }
    .gif-hint {
      margin-top: 8px;
      font-size: 11px;
      color: #666;
      font-style: italic;
    }

    /* Modal for expanded GIF */
    .gif-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
    }
    .gif-modal-content {
      position: relative;
      max-width: 90%;
      max-height: 90%;
    }
    .gif-modal img {
      width: auto;
      height: 80vh;
      max-width: 100%;
      border-radius: 10px;
      object-fit: contain;
    }
    .close-modal {
      position: absolute;
      top: -40px;
      right: 0;
      color: white;
      font-size: 35px;
      font-weight: bold;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0 10px;
    }
    .close-modal:hover {
      color: #ccc;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .no-logs {
      text-align: center;
      padding: 40px;
      color: #999;
      background: white;
      border-radius: 10px;
    }

    /* Mobile responsiveness */
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      
      .log-body {
        flex-direction: column;
      }
      
      .gif-column {
        margin-top: 15px;
      }
      
      .gif-thumbnail {
        width: 100px;
        height: 178px;
      }
    }
  </style>
</head>
<body>
  <button class="back-btn" onclick="window.location.href='dashboard.html'">‚Üê Back to Dashboard</button>
  
  <h2>üìä Workout History</h2>

  <div class="filter-section">
    <label for="dateFilter">Filter by Date:</label>
    <input type="date" id="dateFilter">
    <button onclick="filterByDate()">Filter</button>
    <button onclick="showAll()">Show All</button>
  </div>
  
  <div id="historyContainer" class="loading">Loading workout history...</div>

  <!-- Modal for expanded GIF -->
  <div id="gifModal" class="gif-modal" onclick="closeModal()">
    <div class="gif-modal-content" onclick="event.stopPropagation()">
      <button class="close-modal" onclick="closeModal()">&times;</button>
      <img id="modalGif" src="" alt="Exercise Demo">
    </div>
  </div>

  <script>
    // Map exercise names to GIF files
    const exerciseGifs = {
      "Bench Press": "gifs/bench-press.gif",
      "Barbell Row": "gifs/barbell-row.gif",
      "Pull-up": "gifs/pull-up.gif",
      "Deadlift": "gifs/deadlift.gif",
      "Overhead Press": "gifs/overhead-press.gif",
      "Dumbbell Curl": "gifs/dumbbell-curl.gif",
      "Squat": "gifs/squat.gif",
      "Leg Press": "gifs/leg-press.gif"
    };

    const historyContainer = document.getElementById("historyContainer");
    const dateFilter = document.getElementById("dateFilter");
    const gifModal = document.getElementById("gifModal");
    const modalGif = document.getElementById("modalGif");
    let allLogs = [];

    // Load workout history
    async function loadHistory(date = null) {
      const token = localStorage.getItem("authToken");
      if (!token) {
        alert("Please log in first");
        window.location.href = "index.html";
        return;
      }

      try {
        let url = "https://alzaaspr-production.up.railway.app/api/logs/history";
        if (date) {
          url += `?date=${date}`;
        }

        const res = await fetch(url, {
          headers: { "Authorization": token }
        });

        if (!res.ok) throw new Error("Failed to fetch history");

        const result = await res.json();
        if (result.success) {
          allLogs = result.data;
          displayHistory(allLogs);
        } else {
          historyContainer.innerHTML = '<div class="no-logs">Error loading history</div>';
        }
      } catch (err) {
        console.error("Error loading history:", err);
        historyContainer.innerHTML = '<div class="no-logs">Failed to load workout history</div>';
      }
    }

    // Display workout history
    function displayHistory(logs) {
      historyContainer.classList.remove("loading");
      
      if (logs.length === 0) {
        historyContainer.innerHTML = '<div class="no-logs">No workout logs found. Start logging workouts!</div>';
        return;
      }

      historyContainer.innerHTML = "";

      // Sort logs by date (newest first)
      logs.sort((a, b) => new Date(b.date) - new Date(a.date));

      logs.forEach(log => {
        const card = document.createElement("div");
        card.classList.add("log-card");

        // Build sets HTML
        let setsHTML = "";
        log.sets.forEach(set => {
          setsHTML += `<div class="set-row">Set ${set.setNumber}: ${set.weight} lbs √ó ${set.reps} reps</div>`;
        });

        // Check if GIF exists for this exercise
        const gifSrc = exerciseGifs[log.exercise.name] || "";
        const gifHTML = gifSrc ? `
          <div class="gif-column">
            <img src="${gifSrc}" 
                 alt="${log.exercise.name}" 
                 class="gif-thumbnail" 
                 onclick="openModal('${gifSrc}')">
            <p class="gif-hint">üëÜ Click to expand</p>
          </div>
        ` : '';

        card.innerHTML = `
          <div class="log-header">
            <div class="log-header-left">
              <div class="exercise-name">${log.exercise.name}</div>
              <div class="log-date">${formatDate(log.date)}</div>
            </div>
          </div>
          <div class="log-body">
            <div class="sets-column">
              ${setsHTML}
            </div>
            ${gifHTML}
          </div>
        `;

        historyContainer.appendChild(card);
      });
    }

    // Open GIF modal
    function openModal(gifSrc) {
      modalGif.src = gifSrc;
      gifModal.style.display = "flex";
    }

    // Close GIF modal
    function closeModal() {
      gifModal.style.display = "none";
    }

    // Format date for display
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { 
        weekday: 'short', 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }

    // Filter by date
    function filterByDate() {
      const date = dateFilter.value;
      if (!date) {
        alert("Please select a date");
        return;
      }
      loadHistory(date);
    }

    // Show all logs
    function showAll() {
      dateFilter.value = "";
      loadHistory();
    }

    // Load all history on page load
    loadHistory();
  </script>
</body>
</html>