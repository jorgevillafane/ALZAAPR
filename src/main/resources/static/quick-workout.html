<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quick Workout</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      background: #f5f5f5;
    }
    h2 { 
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }
    .back-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .back-btn:hover {
      background: #5a6268;
    }
    .form-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    label { 
      display: block;
      margin-top: 15px;
      font-weight: bold;
      color: #333;
    }
    select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    /* Exercise Demo Section */
    .exercise-demo {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      text-align: center;
      display: none;
    }
    .exercise-demo h3 {
      margin: 0 0 15px 0;
      color: #007bff;
      font-size: 18px;
    }
    .gif-thumbnail {
      width: 200px;
      height: 355px; /* 9:16 aspect ratio */
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      border: 3px solid #007bff;
      object-fit: cover;
      margin: 0 auto;
      display: block;
    }
    .gif-thumbnail:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    }
    .click-hint {
      margin-top: 10px;
      font-size: 12px;
      color: #666;
      font-style: italic;
    }

    /* Modal for expanded GIF */
    .gif-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
    }
    .gif-modal-content {
      position: relative;
      max-width: 90%;
      max-height: 90%;
    }
    .gif-modal img {
      width: auto;
      height: 80vh;
      max-width: 100%;
      border-radius: 10px;
      object-fit: contain;
    }
    .close-modal {
      position: absolute;
      top: -40px;
      right: 0;
      color: white;
      font-size: 35px;
      font-weight: bold;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0 10px;
    }
    .close-modal:hover {
      color: #ccc;
    }

    .set-input-row {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      align-items: center;
    }
    .set-input-row input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    .log-set-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px;
      white-space: nowrap;
    }
    .log-set-btn:hover {
      background: #0056b3;
    }
    .logged-sets {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 2px solid #eee;
    }
    .logged-sets h4 {
      margin-bottom: 10px;
      color: #333;
    }
    .set-item {
      background: #e9f7ef;
      padding: 10px 15px;
      margin-bottom: 8px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 3px solid #28a745;
    }
    .set-item .set-info {
      color: #333;
    }
    .delete-set-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 3px;
      font-size: 12px;
    }
    .delete-set-btn:hover {
      background: #c82333;
    }
    .finish-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 15px;
      cursor: pointer;
      width: 100%;
      font-size: 16px;
      border-radius: 5px;
      margin-top: 20px;
    }
    .finish-btn:hover {
      background: #218838;
    }
    .finish-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .new-exercise-btn {
      background: #17a2b8;
      color: white;
      border: none;
      padding: 12px;
      cursor: pointer;
      width: 100%;
      font-size: 14px;
      border-radius: 5px;
      margin-top: 10px;
    }
    .new-exercise-btn:hover {
      background: #138496;
    }
    .workout-summary {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }
    .workout-summary h3 {
      color: #007bff;
      margin-bottom: 10px;
    }
    .summary-sets {
      color: #666;
      font-size: 14px;
      line-height: 1.6;
    }

    /* Mobile responsiveness */
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      
      .form-card {
        padding: 15px;
      }
      
      .gif-thumbnail {
        width: 150px;
        height: 267px;
      }
      
      .set-input-row {
        flex-direction: column;
        gap: 8px;
      }
      
      .set-input-row input {
        width: 100%;
      }
      
      .log-set-btn {
        width: 100%;
        padding: 12px 20px;
      }
      
      .set-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .delete-set-btn {
        align-self: flex-end;
      }
    }
  </style>
</head>
<body>
  <button class="back-btn" onclick="window.location.href='dashboard.html'">‚Üê Back to Dashboard</button>
  
  <h2>Quick Workout</h2>

  <div class="form-card">
    <label for="bodyPart">Body Part</label>
    <select id="bodyPart">
      <option value="">-- Select Body Part --</option>
      <option value="Chest">Chest</option>
      <option value="Back">Back</option>
      <option value="Shoulders">Shoulders</option>
      <option value="Arms">Arms</option>
      <option value="LegsQuads">Legs (Quads)</option>
      <option value="LegsHamstrings">Legs (Hamstrings)</option>
      <option value="Core">Core</option>
    </select>

    <label for="exercise">Exercise</label>
    <select id="exercise" disabled>
      <option value="">-- Select Exercise --</option>
    </select>

    <!-- Exercise Demo Section -->
    <div class="exercise-demo" id="exerciseDemo">
      <h3 id="exerciseName"></h3>
      <img id="exerciseGif" class="gif-thumbnail" onclick="openModal()" alt="Exercise demonstration">
      <p class="click-hint">üëÜ Click to expand</p>
    </div>

    <div id="setInputSection" style="display: none;">
      <div class="set-input-row">
        <input type="number" id="weightInput" placeholder="Weight (lbs)" step="0.5">
        <input type="number" id="repsInput" placeholder="Reps">
        <button class="log-set-btn" onclick="logSet()">Log Set</button>
      </div>

      <div class="logged-sets" id="loggedSets" style="display: none;">
        <h4>Logged Sets</h4>
        <div id="setsContainer"></div>
        <button class="finish-btn" onclick="finishExercise()">Finish Exercise</button>
        <button class="new-exercise-btn" onclick="startNewExercise()">Start New Exercise</button>
      </div>
    </div>
  </div>

  <div id="workoutSummary"></div>

  <!-- Modal for expanded GIF -->
  <div id="gifModal" class="gif-modal" onclick="closeModal()">
    <div class="gif-modal-content" onclick="event.stopPropagation()">
      <button class="close-modal" onclick="closeModal()">&times;</button>
      <img id="modalGif" src="" alt="Exercise demonstration">
    </div>
  </div>

  <script>
    // Map exercise names to GIF files
    const exerciseGifs = {
      "Bench Press": "gifs/bench-press.gif",
      "Barbell Row": "gifs/barbell-row.gif",
      "Pull-up": "gifs/pull-up.gif",
      "Deadlift": "gifs/deadlift.gif",
      "Overhead Press": "gifs/overhead-press.gif",
      "Dumbbell Curl": "gifs/dumbbell-curl.gif",
      "Squat": "gifs/squat.gif",
      "Leg Press": "gifs/leg-press.gif"
    };

    const exercisesByBodyPart = {
      Chest: ["Bench Press"],
      Back: ["Barbell Row", "Pull-up", "Deadlift"],
      Shoulders: ["Overhead Press"],
      Arms: ["Dumbbell Curl"],
      LegsQuads: ["Squat", "Leg Press"],
      LegsHamstrings: ["Deadlift"],
      Core: []
    };

    const bodyPartSelect = document.getElementById("bodyPart");
    const exerciseSelect = document.getElementById("exercise");
    const exerciseDemo = document.getElementById("exerciseDemo");
    const exerciseName = document.getElementById("exerciseName");
    const exerciseGif = document.getElementById("exerciseGif");
    const setInputSection = document.getElementById("setInputSection");
    const weightInput = document.getElementById("weightInput");
    const repsInput = document.getElementById("repsInput");
    const loggedSets = document.getElementById("loggedSets");
    const setsContainer = document.getElementById("setsContainer");
    const workoutSummary = document.getElementById("workoutSummary");
    const gifModal = document.getElementById("gifModal");
    const modalGif = document.getElementById("modalGif");

    let exercisesMap = {};
    let currentSets = [];
    let currentExerciseName = "";
    let currentBodyPart = "";
    let completedExercises = [];

    // Load exercises from backend
    async function loadExercises() {
      const token = localStorage.getItem("authToken");
      if (!token) {
        alert("Please log in first");
        window.location.href = "index.html";
        return;
      }

      try {
        const res = await fetch("https://alzaaspr-production.up.railway.app/api/exercises", {
          headers: { "Authorization": token }
        });

        if (!res.ok) throw new Error("Failed to fetch exercises");

        const exercises = await res.json();
        exercisesMap = {};
        exercises.forEach(ex => {
          exercisesMap[ex.name] = ex.id;
        });
      } catch (err) {
        console.error("Error loading exercises:", err);
        alert("Could not load exercises from server.");
      }
    }

    // Populate exercises when body part changes
    bodyPartSelect.addEventListener("change", () => {
      const bodyPart = bodyPartSelect.value;
      exerciseSelect.innerHTML = '<option value="">-- Select Exercise --</option>';
      if (bodyPart && exercisesByBodyPart[bodyPart]) {
        exercisesByBodyPart[bodyPart].forEach(ex => {
          const option = document.createElement("option");
          option.value = ex;
          option.textContent = ex;
          exerciseSelect.appendChild(option);
        });
        exerciseSelect.disabled = false;
      } else {
        exerciseSelect.disabled = true;
        setInputSection.style.display = "none";
        exerciseDemo.style.display = "none";
      }
    });

    // Show exercise GIF and set input when exercise is selected
    exerciseSelect.addEventListener("change", () => {
      if (exerciseSelect.value) {
        currentExerciseName = exerciseSelect.value;
        currentBodyPart = bodyPartSelect.value;
        currentSets = [];
        
        // Show exercise name
        exerciseName.textContent = currentExerciseName;
        
        // Load GIF if available
        if (exerciseGifs[currentExerciseName]) {
          exerciseGif.src = exerciseGifs[currentExerciseName];
          exerciseDemo.style.display = "block";
        } else {
          exerciseDemo.style.display = "none";
        }
        
        setInputSection.style.display = "block";
        loggedSets.style.display = "none";
        setsContainer.innerHTML = "";
        weightInput.value = "";
        repsInput.value = "";
        weightInput.focus();
      } else {
        setInputSection.style.display = "none";
        exerciseDemo.style.display = "none";
      }
    });

    // Open GIF modal
    function openModal() {
      if (exerciseGifs[currentExerciseName]) {
        modalGif.src = exerciseGifs[currentExerciseName];
        gifModal.style.display = "flex";
      }
    }

    // Close GIF modal
    function closeModal() {
      gifModal.style.display = "none";
    }

    // Log a single set
    function logSet() {
      const weight = parseFloat(weightInput.value);
      const reps = parseInt(repsInput.value);

      if (!weight || weight <= 0 || !reps || reps <= 0) {
        alert("Please enter valid weight and reps");
        return;
      }

      const setNumber = currentSets.length + 1;
      currentSets.push({ setNumber, weight, reps });

      const setItem = document.createElement("div");
      setItem.classList.add("set-item");
      setItem.innerHTML = `
        <span class="set-info">Set ${setNumber}: ${weight} lbs √ó ${reps} reps</span>
        <button class="delete-set-btn" onclick="deleteSet(${setNumber - 1})">Delete</button>
      `;
      setsContainer.appendChild(setItem);

      loggedSets.style.display = "block";

      weightInput.value = "";
      repsInput.value = "";
      weightInput.focus();
    }

    // Delete a set
    function deleteSet(index) {
      currentSets.splice(index, 1);
      currentSets.forEach((set, i) => {
        set.setNumber = i + 1;
      });
      setsContainer.innerHTML = "";
      currentSets.forEach((set, i) => {
        const setItem = document.createElement("div");
        setItem.classList.add("set-item");
        setItem.innerHTML = `
          <span class="set-info">Set ${set.setNumber}: ${set.weight} lbs √ó ${set.reps} reps</span>
          <button class="delete-set-btn" onclick="deleteSet(${i})">Delete</button>
        `;
        setsContainer.appendChild(setItem);
      });

      if (currentSets.length === 0) {
        loggedSets.style.display = "none";
      }
    }

    // Finish exercise and save to backend
    async function finishExercise() {
      if (currentSets.length === 0) {
        alert("Please log at least one set");
        return;
      }

      const exerciseId = exercisesMap[currentExerciseName];
      if (!exerciseId) {
        alert("Exercise not found");
        return;
      }

      const token = localStorage.getItem("authToken");
      const log = {
        exerciseId: exerciseId,
        date: new Date().toISOString().split("T")[0],
        sets: currentSets.map(s => ({ reps: s.reps, weight: s.weight }))
      };

      try {
        const response = await fetch("https://alzaaspr-production.up.railway.app/api/logs", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": token
          },
          body: JSON.stringify(log)
        });

        const result = await response.json();
        if (result.success) {
          completedExercises.push({
            bodyPart: currentBodyPart,
            exercise: currentExerciseName,
            sets: [...currentSets]
          });

          displayWorkoutSummary();
          startNewExercise();
        } else {
          alert("Error saving workout: " + result.message);
        }
      } catch (error) {
        console.error("Error:", error);
        alert("Could not connect to server.");
      }
    }

    // Start a new exercise
    function startNewExercise() {
      bodyPartSelect.value = "";
      exerciseSelect.value = "";
      exerciseSelect.disabled = true;
      setInputSection.style.display = "none";
      exerciseDemo.style.display = "none";
      currentSets = [];
      currentExerciseName = "";
      currentBodyPart = "";
      bodyPartSelect.focus();
    }

    // Display workout summary
    function displayWorkoutSummary() {
      if (completedExercises.length === 0) {
        workoutSummary.innerHTML = "";
        return;
      }

      let summaryHTML = "";
      completedExercises.forEach(ex => {
        let setsHTML = ex.sets.map(s => 
          `Set ${s.setNumber}: ${s.weight} lbs √ó ${s.reps} reps`
        ).join("<br>");

        summaryHTML += `
          <div class="workout-summary">
            <h3>${ex.bodyPart} - ${ex.exercise}</h3>
            <div class="summary-sets">${setsHTML}</div>
          </div>
        `;
      });

      workoutSummary.innerHTML = summaryHTML;
    }

    // Allow Enter key to move between inputs
    weightInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        repsInput.focus();
      }
    });

    repsInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        logSet();
      }
    });

    loadExercises();
  </script>
</body>
</html>