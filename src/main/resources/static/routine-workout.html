<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Routine Workout</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 700px;
      margin: auto;
      background: #f5f5f5;
    }
    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 10px;
    }
    .routine-subtitle {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin-bottom: 30px;
    }
    .back-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .back-btn:hover {
      background: #5a6268;
    }
    
    /* Exercise Card Styles */
    .exercise-card {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .exercise-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .exercise-name {
      font-size: 20px;
      font-weight: bold;
      color: #007bff;
    }
    .exercise-number {
      background: #007bff;
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
    }

    /* GIF Demo Section */
    .exercise-demo {
      text-align: center;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .gif-thumbnail {
      width: 180px;
      height: 320px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      border: 3px solid #007bff;
      object-fit: cover;
      display: block;
      margin: 0 auto;
    }
    .gif-thumbnail:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    }
    .click-hint {
      margin-top: 10px;
      font-size: 12px;
      color: #666;
      font-style: italic;
    }

    /* Modal for expanded GIF */
    .gif-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
    }
    .gif-modal-content {
      position: relative;
      max-width: 90%;
      max-height: 90%;
    }
    .gif-modal img {
      width: auto;
      height: 80vh;
      max-width: 100%;
      border-radius: 10px;
      object-fit: contain;
    }
    .close-modal {
      position: absolute;
      top: -40px;
      right: 0;
      color: white;
      font-size: 35px;
      font-weight: bold;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0 10px;
    }
    .close-modal:hover {
      color: #ccc;
    }

    /* Sets Section */
    .sets-section {
      margin-top: 15px;
    }
    .set-label {
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
      display: block;
    }
    .set-input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .set-number {
      min-width: 60px;
      font-weight: bold;
      color: #666;
    }
    .set-input-row input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    .exercise-complete-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 12px;
      cursor: pointer;
      width: 100%;
      border-radius: 5px;
      margin-top: 10px;
      font-size: 15px;
      font-weight: bold;
    }
    .exercise-complete-btn:hover {
      background: #218838;
    }
    .exercise-complete-btn.completed {
      background: #6c757d;
      cursor: not-allowed;
    }
    .exercise-complete-btn.completed:hover {
      background: #6c757d;
    }

    /* Finish Routine Button */
    .finish-routine-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 18px;
      cursor: pointer;
      width: 100%;
      font-size: 18px;
      border-radius: 5px;
      margin-top: 30px;
      font-weight: bold;
      position: sticky;
      bottom: 20px;
    }
    .finish-routine-btn:hover {
      background: #0056b3;
    }
    .finish-routine-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    /* Mobile responsiveness */
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      
      .exercise-card {
        padding: 15px;
      }

      .gif-thumbnail {
        width: 140px;
        height: 249px;
      }
      
      .exercise-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .set-input-row {
        flex-wrap: wrap;
      }
      
      .set-number {
        width: 100%;
      }
      
      .set-input-row input {
        min-width: 0;
      }
    }
  </style>
</head>
<body>
  <button class="back-btn" onclick="window.location.href='select-routine.html'">‚Üê Back to Routines</button>
  
  <h2 id="routineTitle">Loading...</h2>
  <p class="routine-subtitle" id="routineSubtitle"></p>
  
  <div id="exercisesContainer" class="loading">Loading routine...</div>
  
  <button id="finishBtn" class="finish-routine-btn" disabled>Complete Routine</button>

  <!-- Modal for expanded GIF -->
  <div id="gifModal" class="gif-modal" onclick="closeModal()">
    <div class="gif-modal-content" onclick="event.stopPropagation()">
      <button class="close-modal" onclick="closeModal()">&times;</button>
      <img id="modalGif" src="" alt="Exercise Demo">
    </div>
  </div>

  <script>
    // Map exercise names to GIF files
    const exerciseGifs = {
      "Bench Press": "gifs/bench-press.gif",
      "Barbell Row": "gifs/barbell-row.gif",
      "Pull-up": "gifs/pull-up.gif",
      "Deadlift": "gifs/deadlift.gif",
      "Overhead Press": "gifs/overhead-press.gif",
      "Dumbbell Curl": "gifs/dumbbell-curl.gif",
      "Squat": "gifs/squat.gif",
      "Leg Press": "gifs/leg-press.gif"
    };

    const exercisesContainer = document.getElementById("exercisesContainer");
    const routineTitle = document.getElementById("routineTitle");
    const routineSubtitle = document.getElementById("routineSubtitle");
    const finishBtn = document.getElementById("finishBtn");
    const gifModal = document.getElementById("gifModal");
    const modalGif = document.getElementById("modalGif");

    let routine = null;
    let exerciseData = [];
    let completedExercises = new Set();

    // Load routine details
    async function loadRoutine() {
      const token = localStorage.getItem("authToken");
      const routineId = localStorage.getItem("activeRoutineId");

      if (!token || !routineId) {
        alert("Please select a routine first");
        window.location.href = "select-routine.html";
        return;
      }

      try {
        const res = await fetch(`https://alzaaspr-production.up.railway.app/api/routines/${routineId}`, {
          headers: { "Authorization": token }
        });

        if (!res.ok) throw new Error("Failed to fetch routine");

        routine = await res.json();
        routineTitle.textContent = routine.name;
        routineSubtitle.textContent = routine.description;
        
        displayExercises();
      } catch (err) {
        console.error("Error loading routine:", err);
        exercisesContainer.innerHTML = '<p style="color: red;">Failed to load routine. Please try again.</p>';
      }
    }

    // Display exercises
    function displayExercises() {
      if (!routine || !routine.exercises || routine.exercises.length === 0) {
        exercisesContainer.innerHTML = '<p>No exercises in this routine.</p>';
        return;
      }

      exercisesContainer.innerHTML = "";
      exercisesContainer.classList.remove("loading");

      routine.exercises.forEach((exercise, index) => {
        const card = document.createElement("div");
        card.classList.add("exercise-card");
        card.id = `exercise-${exercise.id}`;

        const gifSrc = exerciseGifs[exercise.name] || "";
        const gifHtml = gifSrc ? `
          <div class="exercise-demo">
            <img src="${gifSrc}" 
                 alt="${exercise.name}" 
                 class="gif-thumbnail" 
                 onclick="openModal('${gifSrc}')">
            <p class="click-hint">üëÜ Click to expand</p>
          </div>
        ` : '';

        // Generate set input rows
        let setsHtml = '';
        for (let i = 1; i <= exercise.sets; i++) {
          setsHtml += `
            <div class="set-input-row">
              <span class="set-number">Set ${i}:</span>
              <input type="number" 
                     placeholder="Weight" 
                     data-exercise-id="${exercise.id}" 
                     data-set-number="${i}" 
                     data-type="weight"
                     step="0.5">
              <input type="number" 
                     placeholder="Reps" 
                     data-exercise-id="${exercise.id}" 
                     data-set-number="${i}" 
                     data-type="reps">
            </div>
          `;
        }

        card.innerHTML = `
          <div class="exercise-header">
            <div class="exercise-name">${exercise.name}</div>
            <div class="exercise-number">Exercise ${index + 1}</div>
          </div>
          
          ${gifHtml}
          
          <div class="sets-section">
            <span class="set-label">${exercise.sets} Sets √ó ${exercise.reps} Reps</span>
            ${setsHtml}
          </div>
          
          <button class="exercise-complete-btn" onclick="markExerciseComplete(${exercise.id})">
            Mark Complete ‚úì
          </button>
        `;

        exercisesContainer.appendChild(card);

        // Store exercise data for later submission
        exerciseData.push({
          id: exercise.id,
          name: exercise.name,
          sets: exercise.sets,
          data: []
        });
      });
    }

    // Open GIF modal
    function openModal(gifSrc) {
      modalGif.src = gifSrc;
      gifModal.style.display = "flex";
    }

    // Close GIF modal
    function closeModal() {
      gifModal.style.display = "none";
    }

    // Mark exercise as complete
    function markExerciseComplete(exerciseId) {
      const card = document.getElementById(`exercise-${exerciseId}`);
      const inputs = card.querySelectorAll(`input[data-exercise-id="${exerciseId}"]`);
      
      // Collect set data
      let sets = [];
      let isValid = true;
      
      for (let i = 0; i < inputs.length; i += 2) {
        const weightInput = inputs[i];
        const repsInput = inputs[i + 1];
        const weight = parseFloat(weightInput.value);
        const reps = parseInt(repsInput.value);
        
        if (!weight || weight <= 0 || !reps || reps <= 0) {
          isValid = false;
          break;
        }
        
        sets.push({ weight, reps });
      }

      if (!isValid) {
        alert("Please fill in all weight and reps for this exercise");
        return;
      }

      // Store the data
      const exerciseIndex = exerciseData.findIndex(e => e.id === exerciseId);
      if (exerciseIndex !== -1) {
        exerciseData[exerciseIndex].data = sets;
      }

      // Mark as completed
      completedExercises.add(exerciseId);
      const btn = card.querySelector(".exercise-complete-btn");
      btn.textContent = "‚úì Completed";
      btn.classList.add("completed");
      btn.disabled = true;

      // Disable inputs
      inputs.forEach(input => input.disabled = true);

      // Check if all exercises are complete
      if (completedExercises.size === routine.exercises.length) {
        finishBtn.disabled = false;
      }
    }

    // Finish routine and save to backend
    finishBtn.addEventListener("click", async () => {
      const token = localStorage.getItem("authToken");
      
      // Prepare logs for all exercises
      const logs = exerciseData
        .filter(ex => completedExercises.has(ex.id))
        .map(ex => ({
          exerciseId: ex.id,
          date: new Date().toISOString().split("T")[0],
          sets: ex.data
        }));

      try {
        // Send each log to backend
        for (const log of logs) {
          const response = await fetch("https://alzaaspr-production.up.railway.app/api/logs", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": token
            },
            body: JSON.stringify(log)
          });

          const result = await response.json();
          if (!result.success) {
            throw new Error(`Failed to save ${log.exerciseId}`);
          }
        }

        alert("üéâ Routine completed successfully!");
        window.location.href = "dashboard.html";
      } catch (error) {
        console.error("Error saving routine:", error);
        alert("Error saving routine. Please try again.");
      }
    });

    // Load routine on page load
    loadRoutine();
  </script>
</body>
</html>